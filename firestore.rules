
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isRole(userId, role) {
      return isSignedIn() && getUserRole(userId) == role;
    }

    function isOneOfRoles(userId, roles) {
      return isSignedIn() && getUserRole(userId) in roles;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isOwnerOrAdmin(userId) {
        return isOwner(userId) || isRole(request.auth.uid, 'admin');
    }

    function isIntermediaryOrAdmin() {
        return isOneOfRoles(request.auth.uid, ['intermediary', 'admin']);
    }
    
    function isIntermediaryOfLocation(locationId) {
        let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        return isRole(request.auth.uid, 'intermediary') && userData.locationId == locationId;
    }
    
    function isIntermediaryOfLocationOrAdmin(locationId) {
        return isIntermediaryOfLocation(locationId) || isRole(request.auth.uid, 'admin');
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------
    
    match /users/{userId} {
      // Admins can read/write any user. Users can only read/write their own document.
      allow read, write: if isOwnerOrAdmin(userId);
      // Only Admins can list all users.
      allow list: if isRole(request.auth.uid, 'admin');

      // Specific rule for profile updates: users can only update their own profile fields.
      allow update: if isOwner(userId)
                    && request.resource.data.keys().hasOnly(['profile']);
    }

    match /cities/{cityId} {
      // City data is public and read-only for clients.
      allow get, list: if isSignedIn();
      allow write: if isRole(request.auth.uid, 'admin');
    }
    
    match /locations/{locationId} {
      // Any signed-in user can view active location details.
      allow get: if isSignedIn() && resource.data.status == 'active';
      // Intermediaries can list active locations for the map. Admins can list all.
      allow list: if isSignedIn();

      // The assigned intermediary or an admin can read the full doc for their dashboard.
      allow read: if isIntermediaryOfLocationOrAdmin(locationId);

      // Intermediary can only update a limited set of non-critical fields.
      allow update: if isIntermediaryOfLocation(locationId)
                      && request.resource.data.keys().hasOnly(['name', 'address', 'description']); // Example editable fields

      // Admins have full control.
      allow create, delete: if isRole(request.auth.uid, 'admin');
      // Prevent client-side modification of critical geo-fields.
      allow update: if isRole(request.auth.uid, 'admin')
                    && !('geohash' in request.resource.data.diff(resource.data).affectedKeys());
    }

    match /books/{bookId} {
        allow read: if isSignedIn();
        allow create: if isOwner(request.resource.data.ownerId) || isRole(request.auth.uid, 'admin');
        allow update, delete: if isOwner(resource.data.ownerId) || isRole(request.auth.uid, 'admin');
    }

    match /users/{userId}/wishlist/{wishlistItemId} {
      allow read, write: if isOwnerOrAdmin(userId);
    }

    match /users/{userId}/swapPasses/{swapPassId} {
      allow read, write: if isOwnerOrAdmin(userId);
    }

    match /swaps/{swapId} {
      allow get: if (isSignedIn() && (request.auth.uid in resource.data.participantIds || isIntermediaryOfLocation(resource.data.locationId))) || isRole(request.auth.uid, 'admin');
      allow list: if isIntermediaryOrAdmin();
      allow create: if (isSignedIn() && request.auth.uid == request.resource.data.wishlistOwnerId);
      // Users can accept/cancel, but CANNOT change status to 'confirmed'. This must be done server-side.
      allow update: if (isSignedIn() && request.auth.uid in resource.data.participantIds)
                    && !("status" in request.resource.data.diff(resource.data).affectedKeys())
                    || (request.resource.data.status != "confirmed");
      allow delete: if isRole(request.auth.uid, 'admin');
    }
    
    match /events/{eventId} {
      allow get, list: if isSignedIn();
      allow create: if isIntermediaryOfLocation(request.resource.data.locationId);
      allow update, delete: if isIntermediaryOfLocation(resource.data.locationId);
    }
    
    match /reward_claims/{claimId} {
        allow create: if isIntermediaryOfLocation(request.resource.data.locationId);
        allow read, list: if isIntermediaryOfLocation(resource.data.locationId) || isRole(request.auth.uid, 'admin');
        allow update, delete: if isRole(request.auth.uid, 'admin');
    }

    match /reviews/{reviewId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.reviewerId;
        allow update: if false; // Immutable
        allow delete: if isRole(request.auth.uid, 'admin');
    }

    match /chats/{chatId} {
      allow read, update, create: if isSignedIn() && request.auth.uid in resource.data.users;
      allow list: if isSignedIn() && request.auth.uid in resource.data.users;

      match /messages/{messageId} {
        allow list, get: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.users.hasAny([request.auth.uid]);
        allow create: if isSignedIn() && (request.auth.uid == request.resource.data.senderId || request.resource.data.senderId == 'system') && get(/databases/$(database)/documents/chats/$(chatId)).data.users.hasAny([request.auth.uid]);
        allow update: if false; // Immutable
        allow delete: if isRole(request.auth.uid, 'admin');
      }
    }
    
    match /mail/{docId} {
        allow read, write, create, list, delete: if false;
    }

    match /leads_readers/{docId} {
        allow create: if true;
        allow read, update, delete, list: if false;
    }

    match /leads_partners/{docId} {
        allow create: if true;
        allow read, update, delete, list: if false;
    }
  }
}
