
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isRole(userId, role) {
      return isSignedIn() && getUserRole(userId) == role;
    }

    function isOneOfRoles(userId, roles) {
      return isSignedIn() && getUserRole(userId) in roles;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isOwnerOrAdmin(userId) {
        return isOwner(userId) || isRole(request.auth.uid, 'admin');
    }

    function isIntermediaryOrAdmin() {
        return isOneOfRoles(request.auth.uid, ['intermediary', 'admin']);
    }
    
    function isIntermediaryOfLocation(locationId) {
        let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        return isRole(request.auth.uid, 'intermediary') && userData.locationId == locationId;
    }
    
    function isIntermediaryOfLocationOrAdmin(locationId) {
        return isIntermediaryOfLocation(locationId) || isRole(request.auth.uid, 'admin');
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------
    
    match /users/{userId} {
      allow read, write: if isOwnerOrAdmin(userId);
      allow list: if isRole(request.auth.uid, 'admin');
    }
    
    match /locations/{locationId} {
      // Any signed-in user can view location details.
      allow get: if isSignedIn();
      // Only the assigned intermediary or an admin can read the full doc / list.
      // This is important for protecting sensitive metrics or settings.
      allow read, list: if isIntermediaryOfLocationOrAdmin(locationId);
      // Only the assigned intermediary or an admin can update (limited fields).
      allow update: if isIntermediaryOfLocationOrAdmin(locationId)
                      && request.resource.data.keys().hasOnly(['name', 'address', 'city', 'location', 'qrToken']); // Example limited fields
      allow create, delete: if isRole(request.auth.uid, 'admin');
    }

    match /books/{bookId} {
        allow read: if isSignedIn();
        allow create: if isOwner(request.resource.data.ownerId) || isRole(request.auth.uid, 'admin');
        allow update, delete: if isOwner(resource.data.ownerId) || isRole(request.auth.uid, 'admin');
    }

    match /users/{userId}/wishlist/{wishlistItemId} {
      allow read, write: if isOwnerOrAdmin(userId);
    }

    match /users/{userId}/swapPasses/{swapPassId} {
      allow read, write: if isOwnerOrAdmin(userId);
    }

    match /swaps/{swapId} {
      // Participants and the intermediary of the location can get the swap. Admins can too.
      allow get: if (isSignedIn() && (request.auth.uid in resource.data.participantIds || isIntermediaryOfLocation(resource.data.locationId))) || isRole(request.auth.uid, 'admin');
      // Intermediaries can list swaps for their location. Admins can list all.
      allow list: if isIntermediaryOrAdmin();
      allow create: if (isSignedIn() && request.auth.uid == request.resource.data.wishlistOwnerId);
      // Users can accept/cancel. Intermediaries CANNOT update status directly (must use Cloud Function).
      allow update: if (isSignedIn() && request.auth.uid in resource.data.participantIds)
                    && !("status" in request.resource.data.diff(resource.data).affectedKeys());
      allow delete: if isRole(request.auth.uid, 'admin');
    }
    
    match /events/{eventId} {
      // Publicly readable
      allow get, list: if isSignedIn();
      // Intermediary can manage events for their location
      allow create: if isIntermediaryOfLocation(request.resource.data.locationId);
      allow update, delete: if isIntermediaryOfLocation(resource.data.locationId);
    }
    
    match /reward_claims/{claimId} {
        allow create: if isIntermediaryOfLocation(request.resource.data.locationId);
        allow read, list: if isIntermediaryOfLocation(resource.data.locationId) || isRole(request.auth.uid, 'admin');
        allow update, delete: if isRole(request.auth.uid, 'admin');
    }

    match /reviews/{reviewId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.reviewerId;
        allow update: if false; // Immutable
        allow delete: if isRole(request.auth.uid, 'admin');
    }

    match /chats/{chatId} {
      allow get, update, create: if isSignedIn() && request.auth.uid in resource.data.users;
      // A user can list chats if their UID is in the 'users' array, which is what the query checks for.
      allow list: if isSignedIn() && request.query.where.users.hasAny([request.auth.uid]);

      match /messages/{messageId} {
        allow list, get: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.users.hasAny([request.auth.uid]);
        allow create: if isSignedIn() && (request.auth.uid == request.resource.data.senderId || request.resource.data.senderId == 'system') && get(/databases/$(database)/documents/chats/$(chatId)).data.users.hasAny([request.auth.uid]);
        allow update: if false; // Immutable
        allow delete: if isRole(request.auth.uid, 'admin');
      }
    }
    
    // --- RULES FOR EMAIL AND LEAD GENERATION ---
    match /mail/{docId} {
        allow read, write, create, list, delete: if false;
    }

    match /leads_readers/{docId} {
        allow create: if true;
        allow read, update, delete, list: if false;
    }

    match /leads_partners/{docId} {
        allow create: if true;
        allow read, update, delete, list: if false;
    }
  }
}
